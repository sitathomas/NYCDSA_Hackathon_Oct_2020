---
title: "Hackathon Data Analysis"
output: html_notebook
---

Add libraries, import and save files.

```{r}
library(tidyverse)
library(ggplot2)

setwd('/Users/jameswelch/Dropbox (Personal)/NYDSA/Work/Hackathons/NYCDSA_Hackathon_Oct_2020/James')

churn_trunc <- read_csv("./trunc_churn.csv")
members_trunc <- read_csv("./trunc_members.csv")
transaction_trunc <- read_csv("./trunc_transaction.csv")
users_trunc <- read_csv("./trunc_users.csv")
```

Wrange that data
-convert numeric dates to actual date types

```{r, resutls = 'hide'}
# members_trunc <- members_trunc %>% 
#   mutate(.,registration_init_time = as.Date(as.character(registration_init_time),"%Y%m%d"))
# transaction_trunc <- transaction_trunc %>%  
#  mutate(.,transaction_date = as.Date(as.character(transaction_date),"%Y%m%d"))
#transaction_trunc <- transaction_trunc %>%  
#  mutate(.,membership_expire_date = as.Date(as.character(membership_expire_date), format = "%Y %m %d"))
users_trunc <- users_trunc %>%  
  mutate(.,date = as.Date(as.character(date),format = "%Y%m%d"))
```

Churn dataframe for QC
```{r}
print("Churn Dataframe")
print(paste0("total entires: ", length(churn_trunc$is_churn)))
print(paste0("number unique msno: ",length(unique(churn_trunc$msno))))
print(paste0("total churns: ", sum(churn_trunc$is_churn)))
print(paste0("percentage churns: ", sum(churn_trunc$is_churn)/length(churn_trunc$is_churn)*100, "%"))

```
Members dataframe for QC
```{r}
print("Members_trunc")
print(paste0("total entires: ", length(members_trunc$msno)))
print(paste0("number unique msno: ",length(unique(members_trunc$msno))))
print(paste0("number of cities: ", length((unique(members_trunc$city)))))
print(paste0("pop range in each city: ", members_trunc %>% group_by(., city) %>% count() %>%  range() ))
print(paste0("City 1 is probably a null when entering the form, or the first city the company started in."))
members_trunc %>% group_by(., city) %>% count()
print("see grouped_df for by city counts")
hist(members_trunc$city)
print("see histograme for by city counts")
print("see df and histogram for bd")
group_by(members_trunc, as.factor(members_trunc$bd)) %>% count()
hist(members_trunc$bd)
hist(members_trunc[which(members_trunc$bd>=5 & members_trunc$bd<100),]$bd)

print("obvious negaitve and extremely high (>100) can be ignored as truthful. ")
print("age=0 is roughly the same count as city, same member ids?")
print(paste0("gender breakdown(Female/male/NA: ",group_by(members_trunc,gender) %>% count())[2])
print("see datagrame of registration types")
members_trunc %>% group_by(., registered_via) %>% count()
print(paste0("Registration start data range",range(members_trunc$registration_init_time)))

```

Explore usage dataset
assemble dataframe with churn added
```{r}
users_seg <- merge(users_trunc,churn_trunc, by='msno', all = TRUE)
```
Missingness
```{r}
sum(is.na(users_seg$date))
#head(users_seg,20)

colSums(is.na(users_seg))

users_seg[is.na(users_seg$date),]
sum(users_seg[is.na(users_seg$date),]$is_churn)
print("percentage churn: ")
(sum(users_seg[is.na(users_seg$date),]$is_churn) / length(users_seg[is.na(users_seg$date),]$is_churn)) * 100


users_seg <- users_seg %>%  filter(., date != is.na(date))

```
Seems to be a by-product of the join, there is msno for users without corresponding user data. Perhaps this is users who pay but don't use the product or some issue with the data collection? The rate of churn seems to be roughly the same (8.9% vs 9.2% overall). These entries with missing data are dropped for this analysis. 


Maybe there is a clear pattern in usage? The log scale was chosen due to the wide spread in listening times.
```{r}
users_seg %>% 
  filter(., total_secs != is.na(total_secs)) %>% 
  mutate(., is_churn = as.factor(is_churn), .keep = c("all")) %>%
  mutate(., total_min = total_secs/60) %>% 
  ggplot(., aes(x = is_churn, y = log(total_min))) +
  geom_boxplot()

users_seg %>% 
  filter(., total_secs != is.na(total_secs)) %>% 
  mutate(., is_churn = as.factor(is_churn), .keep = c("all")) %>%
  mutate(., total_min = total_secs/60) %>% 
  ggplot(., aes(x = is_churn, y = (total_min))) +
  geom_boxplot()

#users_seg %>% 
  # filter(., total_secs != is.na(total_secs)) %>% 
  # mutate(., is_churn = as.factor(is_churn), .keep = c("all")) %>%
  # mutate(., total_min = total_secs/60) %>% 
  # ggplot(., aes(x = is_churn, y = log(total_min))) +
  # geom_violin()
```
Visually, they look identical. There are some weird outliers, 2000 minutes of songs per day? Maybe the date feature is when the user started a session in rather than the strict date of play?

Statistically 
```{r}
user_seg_ttest <- users_seg %>% 
  mutate(., is_churn = as.factor(is_churn), .keep = c("all"))

  t.test(user_seg_ttest$total_secs[user_seg_ttest$is_churn == 0], y = user_seg_ttest$total_secs[user_seg_ttest$is_churn == 1], var.equal = F)
  var.test(user_seg_ttest$total_secs[user_seg_ttest$is_churn == 0], y = user_seg_ttest$total_secs[user_seg_ttest$is_churn == 1])
  
  print("Not Churn Mean")
  mean(user_seg_ttest$total_secs[user_seg_ttest$is_churn == 0])
  print("Churn Mean")
  mean(user_seg_ttest$total_secs[user_seg_ttest$is_churn == 1])
  print("difference in means:")
  mean(user_seg_ttest$total_secs[user_seg_ttest$is_churn == 0]) - mean(user_seg_ttest$total_secs[user_seg_ttest$is_churn == 1])
  print("or in minutes: ")
    (mean(user_seg_ttest$total_secs[user_seg_ttest$is_churn == 0]) - mean(user_seg_ttest$total_secs[user_seg_ttest$is_churn == 1])) / 60
```
This also appear indistingusihable. Perhaps the pattern of usage, rather than the total will better characterize those who leave? Varience is unequal between the groups higher in the non-churn group.


How much data do we have for each user?
```{r}
msno_days <- users_seg %>% 
  group_by(., msno) %>% 
  count(., msno, is_churn)

#unique users / quick QC
#without date grouping = 15457
# with date grouping = 277101, which is equivalent to our inital set
print("number of unique msno in users_truncated")
length(unique(users_seg$msno))
print("number of msno when counting dates")
length(msno_days$msno)

msno_days %>% 
  ggplot(., aes(x = n,)) +
  geom_histogram(bins = 31) 

msno_days %>% 
  ggplot(., aes(x = n)) +
  geom_density()


```

Exploring number of days the product is used might be a fruitful avenue as an independent analysis.
Why is 15 such a common amount compared to 14 or 16? Perhaps we are catching people signing up in the middle of the data capture? 
```{r}
msno_days %>% 
  ggplot(., aes(x = as.factor(is_churn), y = n)) +
  geom_boxplot() +
  ylab("Number of days of observations per msno")
```
Again, there seems to be a slight difference between, perhaps the shape is different?


```{r}
msno_days %>% 
  ggplot(., aes(x = n, group = as.factor(is_churn), fill = as.factor(is_churn))) +
  geom_density(alpha = 0.4, position = "fill")
```





How do we characterize a day or activity?
- engagement (number of interventions in playing)
- choosiness (number of interventions before 75 or 98%)
-percentage completed
-average song length (feels weak)
-date played?
How do we characterize multiple days?
How do we characterize a user?

Ideas
- how does user behavior and likelihood to stay interact?
- high intervention versus low intervention in song choice
- city by city usage patterns?
- are payment methods more likely to churn than others?
- how are the people that leave?
--what does usage look like?
--what payment plans, information?


